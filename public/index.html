<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#2563eb">

  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --border: #1e293b;
      --bot: #1e293b;
      --user: #2563eb;
      --text: #ffffff;
      --btn: #334155;
      --btn-hover: #475569;
    }

    body.light {
      --bg: #f1f5f9;
      --panel: #ffffff;
      --border: #e2e8f0;
      --bot: #e5e7eb;
      --user: #2563eb;
      --text: #020617;
      --btn: #cbd5f5;
      --btn-hover: #94a3b8;
    }

    body {
      font-family: system-ui;
      background: linear-gradient(135deg, var(--bg), #0f172a);
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text);
    }

    .chat-container {
      width: 100%;
      max-width: 420px;
      height: 92vh;
      background: var(--panel);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      overflow: hidden;
    }

    header {
      padding: 16px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .header-btn {
      position: absolute;
      top: 14px;
      background: var(--btn);
      border: none;
      color: var(--text);
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: 0.2s;
    }

    .header-btn:hover {
      background: var(--btn-hover);
      transform: scale(1.05);
    }

    .theme-btn { right: 50px; }
    .export-btn { left: 20px; }
    .clear-btn { right: 16px; }

    .messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 80%;
      padding: 12px 14px;
      border-radius: 12px;
      animation: fadeIn 0.25s ease-in;
      font-size: 15px;
    }

    .user {
      background: var(--user);
      align-self: flex-end;
      color: white;
    }

    .bot {
      background: var(--bot);
      align-self: flex-start;
    }

    .system {
      background: transparent;
      color: #94a3b8;
      font-size: 13px;
      align-self: center;
    }

    .typing {
      display: flex;
      gap: 5px;
      padding: 10px;
    }

    .dot {
      width: 6px;
      height: 6px;
      background: #94a3b8;
      border-radius: 50%;
      animation: wave 1.3s infinite ease-in-out;
    }

    .dot:nth-child(2) { animation-delay: .2s }
    .dot:nth-child(3) { animation-delay: .4s }

    @keyframes wave {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }

    footer {
      display: flex;
      padding: 12px;
      border-top: 1px solid var(--border);
      gap: 10px;
    }

    input {
      flex: 1;
      padding: 12px;
      font-size: 15px;
      border-radius: 10px;
      border: none;
      outline: none;
    }

    button {
      background: var(--user);
      border: none;
      padding: 0 16px;
      border-radius: 10px;
      font-size: 15px;
      color: white;
      cursor: pointer;
    }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0 }
      40% { opacity: 1 }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .mic {
  background: #dc2626;
}

.mic.active {
  animation: pulse 1.2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.15); }
  100% { transform: scale(1); }
}

/* ================= AUTH PAGE ================= */

.auth-container {
  width: 100%;
  max-width: 400px;
  background: var(--panel);
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.auth-container h2 {
  text-align: center;
  margin-bottom: 10px;
}

.auth-container input {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text);
  font-size: 14px;
}

.auth-container button {
  padding: 12px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
}

.auth-container .register-btn {
  background: #2563eb;
  color: white;
}

.auth-container .login-btn {
  background: #16a34a;
  color: white;
}

.auth-container button:hover {
  opacity: 0.9;
}

.auth-error {
  color: #ef4444;
  font-size: 14px;
  text-align: center;
}

  </style>
</head>
<body>

<div class="chat-container">
  <header>
    AI Chatbot ðŸ¤–
    <button class="header-btn theme-btn" onclick="toggleTheme()">ðŸŒ™</button>
    <button class="header-btn export-btn" onclick="exportChat()">â¬‡ Export</button>
    <button class="header-btn clear-btn" onclick="clearChat()">ðŸ—‘</button>
    <button class="header-btn" id="muteBtn" style="right:92px">ðŸ”Š</button>
    <button class="header-btn" style="left:120px" onclick="logout()">ðŸšª</button>
  </header>

  <div class="messages" id="messages"></div>

  <footer>
    <input id="input" placeholder="Type or speak..." autocomplete="off" />
    <button id="micBtn" class="mic">ðŸŽ¤</button>
    <button id="sendBtn">Send</button>
  </footer>
</div>

<div class="auth-container" id="authScreen">
  <h2>Login Required</h2>

  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />

  <button class="register-btn" onclick="register()">Register</button>
  <button class="login-btn" onclick="login()">Login</button>
  <button onclick="forgotPassword()" style="background:#f59e0b;color:white;">
  Forgot Password
</button>

  <div id="authMessage" class="auth-error"></div>
</div>


<script>
  const API_URL = "/chat";
  let token = localStorage.getItem("token");
  const messages = document.getElementById("messages");
  const input = document.getElementById("input");
  const button = document.getElementById("sendBtn");
  const micBtn = document.getElementById("micBtn");
  const muteBtn = document.getElementById("muteBtn");

  let selectedVoice = null;

function loadVoices() {
  const voices = speechSynthesis.getVoices();

  // Try to find a female English voice
  selectedVoice =
    voices.find(v => v.name.toLowerCase().includes("female")) ||
    voices.find(v => v.name.includes("Google UK English Female")) ||
    voices.find(v => v.lang === "en-US") ||
    voices[0];
}

speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

async function loadHistoryFromServer() {
  const res = await fetch("/history", {
    headers: {
      "Authorization": "Bearer " + token
    }
  });

  const data = await res.json();

  data.forEach(chat => {
    addMessage(chat.message, "user", false);
    addMessage(chat.reply, "bot", false);
  });
}

async function forgotPassword() {
  const email = document.getElementById("email").value;
  const newPassword = prompt("Enter your new password:");

  if (!email || !newPassword) {
    document.getElementById("authMessage").textContent =
      "Email and new password required";
    return;
  }

  const res = await fetch("/forgot-password", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, newPassword })
  });

  const data = await res.json();
  document.getElementById("authMessage").textContent = data.message;
}

/* ============================= */
  /* SETTINGS + STATE */
  /* ============================= */

  let isSending = false;
  let isMuted = localStorage.getItem("muted") === "true";
  const history = JSON.parse(localStorage.getItem("chat")) || [];

  /* ============================= */
/* INIT */
/* ============================= */

document.addEventListener("DOMContentLoaded", () => {

  const chatContainer = document.querySelector(".chat-container");
  const authScreen = document.getElementById("authScreen");

  let token = localStorage.getItem("token");

  if (!token) {
    chatContainer.style.display = "none";
    authScreen.style.display = "flex";
  } else {
    authScreen.style.display = "none";
    chatContainer.style.display = "flex";
    loadHistoryFromServer();
  }

  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
  }

  updateMuteIcon();

});


  /* ============================= */
  /* UI FUNCTIONS */
  /* ============================= */

  function updateMuteIcon() {
    muteBtn.textContent = isMuted ? "ðŸ”‡" : "ðŸ”Š";
  }

  muteBtn.onclick = () => {
    isMuted = !isMuted;
    localStorage.setItem("muted", isMuted);
    updateMuteIcon();
    speechSynthesis.cancel();
  };

  function saveHistory() {
    localStorage.setItem("chat", JSON.stringify(history));
  }

  function addMessage(text, role, save = true) {
    const div = document.createElement("div");
    div.className = "message " + role;
    div.textContent = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;

    if (save) {
      history.push({ text, role });
      saveHistory();
    }
  }

  function showTyping() {
  const typing = document.createElement("div");
  typing.className = "message bot typing";

  typing.innerHTML = `
    <span style="display:flex;gap:4px">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </span>
  `;

  messages.appendChild(typing);
  messages.scrollTo({ top: messages.scrollHeight, behavior: "smooth" });

  return typing;
}

  /* ============================= */
  /* SEND MESSAGE */
  /* ============================= */

  async function sendMessage() {
    if (isSending) return;

    const text = input.value.trim();
    if (!text) return;

    isSending = true;
    input.disabled = true;
    button.disabled = true;

    addMessage(text, "user");
    input.value = "";

    const typing = showTyping();

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },

        body: JSON.stringify({ message: text })
      });

      if (!res.ok) {
      throw new Error("Server error");
   }


      typing.remove();

      const reader = res.body.getReader();
      const decoder = new TextDecoder();

      let botText = "";

      // Create empty bot bubble
      const botDiv = document.createElement("div");
      botDiv.className = "message bot";
      messages.appendChild(botDiv);

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        botText += chunk;
        botDiv.textContent = botText;

        messages.scrollTop = messages.scrollHeight;
     }

      // Save full message after streaming completes
      history.push({ text: botText, role: "bot" });
      saveHistory();

     // Speak only once after full message arrives
     if (!isMuted && selectedVoice) {
       const speech = new SpeechSynthesisUtterance(botText);
       speech.voice = selectedVoice;
       speech.rate = 1;
       speech.pitch = 1.1;
       speechSynthesis.cancel();
       speechSynthesis.speak(speech);
     }

    } catch {
      typing.remove();
      addMessage("âš ï¸ Server error", "bot");
    }

    isSending = false;
    input.disabled = false;
    button.disabled = false;
    input.focus();
  }

  /* ============================= */
  /* CLEAR + EXPORT + THEME */
  /* ============================= */

  function clearChat() {
    if (!confirm("Clear entire chat history?")) return;
    messages.innerHTML = "";
    history.length = 0;
    saveHistory();
    addMessage("Chat cleared ðŸ§¹", "system", false);
  }

  function exportChat() {
    if (history.length === 0) return alert("No chat to export");

    let text = "AI Chatbot Conversation\n\n";
    history.forEach(m => {
      text += `${m.role === "user" ? "You" : "Bot"}: ${m.text}\n\n`;
    });

    const blob = new Blob([text], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "chat-history.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function toggleTheme() {
    document.body.classList.toggle("light");
    localStorage.setItem(
      "theme",
      document.body.classList.contains("light") ? "light" : "dark"
    );
  }

  /* ============================= */
  /* SPEECH SYNTHESIS */
  /* ============================= */

  function speak(text) {
    if (!window.speechSynthesis || isMuted) return;

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "en-US";
    utterance.rate = 1;
    utterance.pitch = 1;

    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
  }

  async function register() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const messageBox = document.getElementById("authMessage");

  try {
    const res = await fetch("/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();
    messageBox.textContent = data.message;

  } catch (err) {
    messageBox.textContent = "Server error";
  }
}

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const res = await fetch("/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password })
  });

  const data = await res.json();

  if (data.token) {
    localStorage.setItem("token", data.token);
    location.reload(); // safest way
  } else {
    document.getElementById("authMessage").textContent = data.message;
  }
}


  /* ============================= */
  /* SPEECH RECOGNITION */
  /* ============================= */

  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if (SpeechRecognition) {
    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.continuous = false;
    recognition.interimResults = false;

    micBtn.onclick = () => {
      recognition.start();
      micBtn.classList.add("active");
    };

    recognition.onresult = (event) => {
      input.value = event.results[0][0].transcript;
      sendMessage(); // auto send after speaking
    };

    recognition.onend = () => {
      micBtn.classList.remove("active");
    };

  } else {
    micBtn.disabled = true;
    micBtn.textContent = "âŒ";
  }

  /* ============================= */
  /* EVENTS */
  /* ============================= */

  button.onclick = sendMessage;
  input.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
  });

  if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js")
    .then(() => console.log("Service Worker Registered"));
}

</script>

</body>
</html>

